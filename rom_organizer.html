<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROM & BIOS Organizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .drag-area-active {
            border-color: #3b82f6; /* blue-500 */
            background-color: #1f2937; /* gray-800 */
        }
        .group-card {
            border: 1px solid #374151; /* gray-700 */
            transition: all 0.2s ease-in-out;
        }
        .group-card:hover {
            border-color: #4b5563; /* gray-600 */
            transform: translateY(-2px);
        }
        .best-rom {
            border: 1px solid #10b981; /* emerald-500 */
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
        }
        .bad-rom {
            color: #ef4444; /* red-500 */
            text-decoration: line-through;
        }
        .proto-rom {
            color: #f59e0b; /* amber-500 */
        }
        .hidden {
            display: none;
        }
        #log-output {
            max-height: 200px;
            overflow-y: auto;
            background-color: #111827; /* gray-900 */
            border: 1px solid #374151; /* gray-700 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8 relative">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">ROM & BIOS Organizer</h1>
            <p class="text-lg text-gray-400">Select files, a folder, or drag and drop your collection to analyze them.</p>
        </header>

        <div id="main-content" class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Left Column: Help Text & Settings -->
            <div id="help-panel" class="md:col-span-1 bg-gray-800/50 rounded-lg p-6 border border-gray-700 h-fit">
                <h3 class="text-lg font-bold text-white mb-4">Tips & Recommendations</h3>
                <div class="space-y-6 text-sm">
                    <div>
                        <h4 class="font-semibold text-emerald-400 mb-1">Important Warning</h4>
                        <p class="text-gray-300">Your browser may show a security prompt that says "Upload". **No files are actually uploaded.** This is a standard prompt that only gives this page permission to read your file names locally.</p>
                    </div>
                     <div>
                        <h4 class="font-semibold text-emerald-400 mb-2">Performance Tuning</h4>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label for="chunk-size-slider" class="text-sm font-medium text-gray-300">Analysis Chunk Size</label>
                                    <span id="chunk-size-value" class="text-sm font-bold text-emerald-400">200</span>
                                </div>
                                <input type="range" id="chunk-size-slider" min="50" max="2000" step="50" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                <p class="text-xs text-gray-400 mt-1">How many files to analyze in a batch. Smaller values are safer and help prevent browser crashes. If you still have issues with a very large collection, try processing fewer folders at once.</p>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label for="breathe-slider" class="text-sm font-medium text-gray-300">Scan Breathe Interval</label>
                                    <span id="breathe-value" class="text-sm font-bold text-emerald-400">100</span>
                                </div>
                                <input type="range" id="breathe-slider" min="50" max="1000" step="50" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                <p class="text-xs text-gray-400 mt-1">How many files to find before pausing. Lower values prevent crashes in huge folders.</p>
                            </div>
                            <div class="text-xs text-gray-500 border-t border-gray-700 pt-4">
                                <p><strong class="text-gray-400">Example for huge folders:</strong> Try setting Breathe Interval to 50 and Chunk Size to 100.</p>
                                <p class="mt-2">If you see a 'Page Unresponsive' message, it's safe to click 'Wait' as the process often continues in the background. This can happen with very large collections, as performance depends on your computer's speed and memory. If it persists, reload the page and try lower performance settings. For extremely large collections, the best approach is to process fewer folders at a time.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Drop Zone & Log -->
            <div class="md:col-span-2 space-y-8">
                <div id="drop-zone-wrapper">
                    <div id="drop-zone" class="border-2 border-dashed border-gray-600 rounded-lg p-8 md:p-16 text-center transition-all duration-300 ease-in-out bg-gray-800/50 h-full flex flex-col justify-center">
                        <div>
                            <svg class="mx-auto h-12 w-12 text-gray-500" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <p class="mt-4 text-lg text-gray-400">
                                <span id="select-files-btn" class="font-semibold text-blue-400 cursor-pointer hover:underline">Click to select files</span>,
                                <span id="select-folder-btn" class="font-semibold text-emerald-400 cursor-pointer hover:underline">select a folder</span>,
                                or drag and drop
                            </p>
                            <p class="text-sm font-semibold text-emerald-300 mt-2">✓ All processing is done securely in your browser. Nothing is uploaded.</p>
                        </div>
                        <input type="file" id="file-input" class="hidden" multiple>
                        <input type="file" id="folder-input" class="hidden" webkitdirectory multiple>
                    </div>
                </div>

                <div id="log-and-progress-area" class="bg-gray-800/50 rounded-lg p-6">
                    <div id="staging-area" class="hidden text-center">
                        <p id="staging-text" class="text-lg text-gray-300 mb-4"></p>
                        <button id="start-analysis-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300">
                            Start Analysis
                        </button>
                    </div>
                    <div id="processing-indicator" class="hidden text-center">
                        <p class="text-lg font-semibold mb-4 text-white">Analyzing Collection...</p>
                        <div class="w-full bg-gray-700 rounded-full h-4 mb-4">
                            <div id="progress-bar" class="bg-emerald-500 h-4 rounded-full transition-all duration-150" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="log-output" class="text-left text-xs font-mono p-4 rounded-md h-48 overflow-y-scroll bg-gray-900 border border-gray-700"></div>
                </div>
            </div>
        </div>

        <!-- Results Area -->
        <div id="results-area" class="mt-8 hidden">
            <!-- Placeholder -->
            <div id="placeholder" class="text-center text-gray-500 py-12">
                <p>No valid ROM/BIOS files found.</p>
            </div>
            <!-- Results Grid -->
            <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Group cards will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Template for a result card -->
    <template id="group-card-template">
        <div class="group-card bg-gray-800 rounded-lg shadow-lg overflow-hidden">
            <div class="p-5">
                <h3 class="text-xl font-bold text-white truncate"></h3>
                <div class="mt-4 space-y-3">
                    <div>
                        <p class="text-sm font-medium text-emerald-400 mb-1">✓ Best Version</p>
                        <div class="best-rom bg-gray-900/50 rounded-md p-3 text-sm"></div>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-400 mb-1">Other Versions</p>
                        <ul class="other-roms-list space-y-2 text-sm text-gray-300"></ul>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const dropZoneWrapper = document.getElementById('drop-zone-wrapper');
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const folderInput = document.getElementById('folder-input');
            const selectFilesBtn = document.getElementById('select-files-btn');
            const selectFolderBtn = document.getElementById('select-folder-btn');
            const mainContent = document.getElementById('main-content');
            const resultsArea = document.getElementById('results-area');
            const placeholder = document.getElementById('placeholder');
            const stagingArea = document.getElementById('staging-area');
            const stagingText = document.getElementById('staging-text');
            const startAnalysisBtn = document.getElementById('start-analysis-btn');
            const processingIndicator = document.getElementById('processing-indicator');
            const progressBar = document.getElementById('progress-bar');
            const logOutput = document.getElementById('log-output');
            const resultsGrid = document.getElementById('results-grid');
            const groupCardTemplate = document.getElementById('group-card-template');
            const chunkSizeSlider = document.getElementById('chunk-size-slider');
            const chunkSizeValue = document.getElementById('chunk-size-value');
            const breatheSlider = document.getElementById('breathe-slider');
            const breatheValue = document.getElementById('breathe-value');

            // --- App State ---
            let worker = null;
            let CHUNK_SIZE = 200;
            let BREATHE_INTERVAL = 100;
            let discoveredFiles = [];

            // --- Worker Script ---
            const workerScript = `
                let groups = {};
                let stats = { totalSize: 0, types: {} };

                self.onmessage = function(e) {
                    const msg = e.data;
                    if (msg.type === 'processChunk') {
                        const chunk = msg.chunk;
                        for (let i = 0; i < chunk.length; i++) {
                            const file = chunk[i];
                            if (!file || !file.name || file.name === '.DS_Store' || file.name === 'Thumbs.db') continue;
                            
                            // Process for grouping
                            const parsed = parseFilename(file.name);
                            if (!groups[parsed.baseName]) groups[parsed.baseName] = [];
                            groups[parsed.baseName].push(parsed);

                            // Process for stats
                            stats.totalSize += file.size;
                            const ext = file.name.split('.').pop().toLowerCase() || 'no_extension';
                            if (!stats.types[ext]) stats.types[ext] = { count: 0, size: 0 };
                            stats.types[ext].count++;
                            stats.types[ext].size += file.size;
                        }
                        self.postMessage({ type: 'chunkProcessed', count: chunk.length });
                    } else if (msg.type === 'finalize') {
                        self.postMessage({ type: 'log', message: 'Analysis complete. Sorting results...' });
                        for (const groupName in groups) {
                            groups[groupName].sort((a, b) => b.score - a.score);
                        }
                        self.postMessage({ type: 'complete', groups: groups, stats: stats });
                    }
                };
                function parseFilename(filename) {
                    let score = 0;
                    const info = { filename, baseName: filename, region: 'Unknown', revision: null, isProto: false, isBadDump: false, isGoodDump: false };
                    const nameMatch = new RegExp("^(.*?)\\\\s*(\\\\(|\\\\[)");
                    const matchResult = filename.match(nameMatch);
                    info.baseName = matchResult ? matchResult[1].trim() : (filename.lastIndexOf('.') > 0 ? filename.substring(0, filename.lastIndexOf('.')) : filename);
                    if (filename.includes('[!]')) { info.isGoodDump = true; score += 1000; }
                    const regionMatch = filename.match(new RegExp("\\\\((USA|World|Europe|Japan|En,Ja|J|E|U)\\\\)","i"));
                    if (regionMatch) { info.region = regionMatch[1]; if (['USA', 'World', 'Europe'].includes(info.region)) score += 100; else if (info.region === 'Japan') score += 50; }
                    const revMatch = filename.match(new RegExp("\\\\((Rev\\\\s*(\\\\d+|\\\\w)|v(\\\\d\\\\.\\\\d))\\\\)", "i"));
                    if (revMatch) { info.revision = revMatch[0]; let revScore = parseFloat(revMatch[2] || revMatch[3] || '0') * 10; if (isNaN(revScore)) { revScore = (revMatch[2].toLowerCase().charCodeAt(0) - 'a'.charCodeAt(0) + 1) * 10; } score += revScore; }
                    if (new RegExp("\\\\[b\\\\d*\\\\]", "i").test(filename)) { info.isBadDump = true; score -= 5000; }
                    if (new RegExp("\\\\(Proto\\\\)", "i").test(filename)) { info.isProto = true; score -= 1000; }
                    info.score = score;
                    return info;
                }
            `;
            const workerBlob = new Blob([workerScript], { type: 'application/javascript' });
            const workerUrl = URL.createObjectURL(workerBlob);

            // --- Functions ---
            function log(message) {
                const timestamp = new Date().toLocaleTimeString();
                const p = document.createElement('p');
                p.innerHTML = `<span class="text-gray-500">${timestamp}:</span> ${message}`;
                logOutput.appendChild(p);
                logOutput.scrollTop = logOutput.scrollHeight;
            }
            
            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }

            function initializeUIForDiscovery() {
                mainContent.classList.add('hidden');
                logOutput.innerHTML = '';
                log('Starting file discovery...');
            }

            async function handleFileSelection(items) {
                if (!items || items.length === 0) return;
                initializeUIForDiscovery();
                
                let entriesProcessedInBatch = 0;
                discoveredFiles = [];

                async function processEntry(entry) {
                    entriesProcessedInBatch++;
                    if (entriesProcessedInBatch > BREATHE_INTERVAL) {
                        await new Promise(r => setTimeout(r, 0));
                        entriesProcessedInBatch = 0;
                    }

                    if (entry.isFile) {
                        const file = await new Promise(resolve => entry.file(resolve));
                        discoveredFiles.push(file);
                    } else if (entry.isDirectory) {
                        log(`Scanning directory: ${entry.name}`);
                        const dirReader = entry.createReader();
                        let entries;
                        do {
                            entries = await new Promise((resolve) => dirReader.readEntries(resolve));
                            for (const subEntry of entries) {
                                await processEntry(subEntry);
                            }
                        } while (entries.length > 0);
                    }
                }

                try {
                    const entries = Array.from(items).map(item => item.webkitGetAsEntry ? item.webkitGetAsEntry() : null).filter(Boolean);
                    if (entries.length > 0) {
                         for (const entry of entries) {
                            await processEntry(entry);
                        }
                    } else { // Fallback for simple file list
                        for(const file of items) {
                            discoveredFiles.push(file);
                        }
                    }
                } catch (e) {
                    log(`<span class="text-red-500">Error during file traversal: ${e.message}</span>`);
                }
                
                log(`Discovery complete. Found ${discoveredFiles.length} total files.`);
                stageForAnalysis();
            }

            function stageForAnalysis() {
                stagingArea.classList.remove('hidden');
                processingIndicator.classList.add('hidden');
                const fileCount = discoveredFiles.length;
                stagingText.textContent = `Found ${fileCount} files. Ready to analyze.`;

                if (fileCount > 100000) {
                    log(`<strong class="text-yellow-400">Recommendation:</strong> Large collection detected. Consider lowering the 'Breathe Interval' and 'Chunk Size' for stability.`);
                } else if (fileCount > 10000) {
                     log(`<strong class="text-yellow-400">Recommendation:</strong> Medium collection detected. Default settings should be fine.`);
                }
            }

            function startAnalysis() {
                if (worker) worker.terminate();
                worker = new Worker(workerUrl);

                stagingArea.classList.add('hidden');
                processingIndicator.classList.remove('hidden');
                resultsArea.classList.add('hidden');
                placeholder.classList.add('hidden');
                resultsGrid.innerHTML = '';
                progressBar.style.width = '0%';
                
                log('Worker initiated. Starting analysis...');

                let processedCount = 0;
                const totalFileCount = discoveredFiles.length;

                worker.onmessage = (e) => {
                    const data = e.data;
                    if (data.type === 'chunkProcessed') {
                        processedCount += data.count;
                        if (totalFileCount > 0) {
                            const percent = Math.round((processedCount / totalFileCount) * 100);
                            progressBar.style.width = `${percent}%`;
                        }
                    } else if (data.type === 'log') {
                        log(data.message);
                    } else if (data.type === 'complete') {
                        progressBar.style.width = `100%`;
                        log('Processing complete.');
                        displayResults(data.groups, data.stats);
                        worker.terminate();
                        worker = null;
                    }
                };

                worker.onerror = (e) => {
                    console.error('Error in worker:', e);
                    log(`<span class="text-red-500">An error occurred: ${e.message}</span>`);
                    if(worker) worker.terminate();
                };

                for (let i = 0; i < totalFileCount; i += CHUNK_SIZE) {
                    const chunk = discoveredFiles.slice(i, i + CHUNK_SIZE).map(f => ({name: f.name, size: f.size}));
                    worker.postMessage({ type: 'processChunk', chunk: chunk });
                }
                worker.postMessage({ type: 'finalize' });
            }
            
            function displayResults(groupedFiles, stats) {
                processingIndicator.classList.add('hidden');
                resultsArea.classList.remove('hidden');
                const sortedGroupKeys = Object.keys(groupedFiles).sort((a, b) => a.localeCompare(b));

                if (sortedGroupKeys.length === 0) {
                    placeholder.classList.remove('hidden');
                } else {
                    log(`Displaying ${sortedGroupKeys.length} groups.`);
                    for (const groupName of sortedGroupKeys) {
                        displayGroup(groupName, groupedFiles[groupName]);
                    }
                }
                
                // Log the final statistics
                log('--- Analysis Summary ---');
                log(`Total Files Processed: ${discoveredFiles.length}`);
                log(`Total Collection Size: ${formatBytes(stats.totalSize)}`);
                log('File Types Breakdown:');
                const sortedTypes = Object.entries(stats.types).sort(([,a],[,b]) => b.count - a.count);
                for(const [ext, data] of sortedTypes) {
                    log(`- .${ext}: ${data.count} files, ${formatBytes(data.size)}`);
                }
                log('--- End of Summary ---');
            }

            function displayGroup(groupName, items) {
                const cardClone = groupCardTemplate.content.cloneNode(true);
                const cardElement = cardClone.querySelector('.group-card');
                const titleElement = cardElement.querySelector('h3');
                const bestRomElement = cardElement.querySelector('.best-rom');
                const otherRomsList = cardElement.querySelector('.other-roms-list');

                titleElement.textContent = groupName;
                titleElement.title = groupName;
                const bestRom = items[0];
                bestRomElement.textContent = bestRom.filename;
                if(bestRom.isBadDump) bestRomElement.classList.add('bad-rom');
                if(bestRom.isProto) bestRomElement.classList.add('proto-rom');

                if (items.length > 1) {
                    items.slice(1).forEach(rom => {
                        const li = document.createElement('li');
                        li.textContent = rom.filename;
                        if (rom.isBadDump) li.classList.add('bad-rom');
                        if (rom.isProto) li.classList.add('proto-rom');
                        otherRomsList.appendChild(li);
                    });
                } else {
                     otherRomsList.parentElement.classList.add('hidden');
                }
                resultsGrid.appendChild(cardElement);
            }

            // --- Settings Logic ---
            function loadSettings() {
                const savedChunkSize = localStorage.getItem('romOrganizerChunkSize');
                if (savedChunkSize) CHUNK_SIZE = parseInt(savedChunkSize, 10);
                chunkSizeSlider.value = CHUNK_SIZE;
                chunkSizeValue.textContent = CHUNK_SIZE;

                const savedBreatheInterval = localStorage.getItem('romOrganizerBreatheInterval');
                if (savedBreatheInterval) BREATHE_INTERVAL = parseInt(savedBreatheInterval, 10);
                breatheSlider.value = BREATHE_INTERVAL;
                breatheValue.textContent = BREATHE_INTERVAL;
            }

            function saveSettings() {
                CHUNK_SIZE = parseInt(chunkSizeSlider.value, 10);
                localStorage.setItem('romOrganizerChunkSize', CHUNK_SIZE);
                chunkSizeValue.textContent = CHUNK_SIZE;

                BREATHE_INTERVAL = parseInt(breatheSlider.value, 10);
                localStorage.setItem('romOrganizerBreatheInterval', BREATHE_INTERVAL);
                breatheValue.textContent = BREATHE_INTERVAL;
                log(`Settings updated. Breathe Interval: ${BREATHE_INTERVAL}, Chunk Size: ${CHUNK_SIZE}`);
            }

            chunkSizeSlider.addEventListener('input', () => chunkSizeValue.textContent = chunkSizeSlider.value);
            chunkSizeSlider.addEventListener('change', saveSettings);
            breatheSlider.addEventListener('input', () => breatheValue.textContent = breatheSlider.value);
            breatheSlider.addEventListener('change', saveSettings);
            
            // --- Initial Event Listeners ---
            loadSettings();
            log('Application ready. Select files or a folder to begin.');
            startAnalysisBtn.addEventListener('click', startAnalysis);
            selectFilesBtn.addEventListener('click', () => fileInput.click());
            selectFolderBtn.addEventListener('click', () => folderInput.click());
            fileInput.addEventListener('change', (e) => handleFileSelection(e.target.files));
            folderInput.addEventListener('change', (e) => handleFileSelection(e.dataTransfer ? e.dataTransfer.items : e.target.files));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-area-active');
                handleFileSelection(e.dataTransfer.items);
            });
            ['dragenter', 'dragover', 'dragleave'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if(eventName === 'dragenter' || eventName === 'dragover') {
                        dropZone.classList.add('drag-area-active');
                    } else {
                        dropZone.classList.remove('drag-area-active');
                    }
                });
            });
        });
    </script>

</body>
</html>
